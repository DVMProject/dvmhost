// SPDX-License-Identifier: GPL-2.0-only
/*
 * Digital Voice Modem - Bridge
 * GPLv2 Open Source. Use is subject to license terms.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 *  Copyright (c) 2011 Matthew Kaufman
 *
 */
/*-
 * mdc_encode.c
 *  Encodes a specific format from 1200 BPS MSK data burst
 *  to output audio samples.
 *
 * 9 October 2010 - typedefs for easier porting
 * 27 July 2016 - additional reduced-amplitude sin tables
 *
 * Author: Matthew Kaufman (matthew@eeph.com)
 *
 * Copyright (c) 2005, 2010  Matthew Kaufman  All rights reserved.
 * 
 *  This file is part of Matthew Kaufman's MDC Encoder/Decoder Library
 *
 *  The MDC Encoder/Decoder Library is free software; you can
 *  redistribute it and/or modify it under the terms of version 2 of
 *  the GNU General Public License as published by the Free Software
 *  Foundation.
 *
 *  If you cannot comply with the terms of this license, contact
 *  the author for alternative license arrangements or do not use
 *  or redistribute this software.
 *
 *  The MDC Encoder/Decoder Library is distributed in the hope
 *  that it will be useful, but WITHOUT ANY WARRANTY; without even the
 *  implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR
 *  PURPOSE.  See the GNU General Public License for more details.
 *
 *  You should have received a copy of the GNU General Public License
 *  along with this software; if not, write to the Free Software
 *  Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA  02110-1301
 *  USA.
 *
 *  or see http://www.gnu.org/copyleft/gpl.html
 *
-*/

#include <stdlib.h>
#include "mdc_encode.h"

#if defined(MDC_SAMPLE_FORMAT_U8)
#if defined(MDC_ENCODE_FULL_AMPLITUDE)

static mdc_sample_t sintable[] = {
      127, 130, 133, 136, 139, 142, 145, 148, 151, 154, 157, 160, 163, 166, 169, 172,
      175, 178, 180, 183, 186, 189, 191, 194, 196, 199, 201, 204, 206, 209, 211, 213,
      215, 218, 220, 222, 224, 226, 227, 229, 231, 233, 234, 236, 237, 239, 240, 241,
      242, 244, 245, 246, 247, 247, 248, 249, 250, 250, 251, 251, 251, 252, 252, 252,
      252, 252, 252, 252, 251, 251, 251, 250, 250, 249, 248, 247, 247, 246, 245, 244,
      242, 241, 240, 239, 237, 236, 234, 233, 231, 229, 227, 226, 224, 222, 220, 218,
      215, 213, 211, 209, 206, 204, 201, 199, 196, 194, 191, 189, 186, 183, 180, 178,
      175, 172, 169, 166, 163, 160, 157, 154, 151, 148, 145, 142, 139, 136, 133, 130,
      127, 124, 121, 118, 115, 112, 109, 106, 103, 100,  97,  94,  91,  88,  85,  82,
      79,  76,  74,  71,  68,  65,  63,  60,  58,  55,  53,  50, 48,  45,  43,  41,
      39,  36,  34,  32,  30,  28,  27,  25, 23,  21,  20,  18,  17,  15,  14,  13,
      12,  10,   9,   8, 7,   7,   6,   5,   4,   4,   3,   3,   3,   2,   2,   2,
      2,   2,   2,   2,   3,   3,   3,   4,   4,   5,   6,   7, 7,   8,   9,  10,
      12,  13,  14,  15,  17,  18,  20,  21, 23,  25,  27,  28,  30,  32,  34,  36,
      39,  41,  43,  45, 48,  50,  53,  55,  58,  60,  63,  65,  68,  71,  74,  76,
      79,  82,  85,  88,  91,  94,  97, 100, 103, 106, 109, 112, 115, 118, 121, 124 };

#else

static mdc_sample_t sintable[] = {
    128, 130, 132, 134, 136, 138, 140, 142, 144, 146, 148, 150, 152, 154, 156, 158, 
    160, 162, 164, 166, 168, 170, 172, 172, 174, 176, 178, 180, 182, 182, 184, 186, 
    188, 190, 190, 192, 194, 194, 196, 198, 198, 200, 200, 202, 202, 204, 204, 206, 
    206, 206, 208, 208, 208, 210, 210, 210, 212, 212, 212, 212, 212, 212, 212, 212, 
    212, 212, 212, 212, 212, 212, 212, 212, 212, 210, 210, 210, 208, 208, 208, 206, 
    206, 206, 204, 204, 202, 202, 200, 200, 198, 198, 196, 194, 194, 192, 190, 190, 
    188, 186, 184, 182, 182, 180, 178, 176, 174, 172, 172, 170, 168, 166, 164, 162, 
    160, 158, 156, 154, 152, 150, 148, 146, 144, 142, 140, 138, 136, 134, 132, 130, 
    128, 126, 124, 122, 120, 118, 116, 114, 112, 110, 108, 106, 104, 102, 100, 98, 
    96,  94,  92,  90,  88,  86,  84,  82,  80,  78,  76,  76,  74,  72,  70,  68, 
    68,  66,  64,  64,  62,  60,  60,  58,  56,  56,  54,  54,  52,  52,  50,  50, 
    48,  48,  48,  46,  46,  46,  44,  44,  44,  44,  44,  42,  42,  42,  42,  42, 
    42,  42,  42,  42,  42,  42,  44,  44,  44,  44,  44,  46,  46,  46,  48,  48, 
    48,  50,  50,  52,  52,  54,  54,  56,  56,  58,  60,  60,  62,  64,  64,  66, 
    68,  68,  70,  72,  74,  76,  76,  78,  80,  82,  84,  86,  88,  90,  92,  94, 
    96,  98,  100, 102, 104, 106, 108, 110, 112, 114, 116, 118, 120, 122, 124, 126 };

#endif

#elif defined(MDC_SAMPLE_FORMAT_U16)
#if defined(MDC_ENCODE_FULL_AMPLITUDE)

static mdc_sample_t sintable[] = {
    32768, 33552, 34337, 35120, 35902, 36682, 37460, 38235,
    39007, 39775, 40538, 41297, 42051, 42799, 43542, 44277,
    45006, 45728, 46441, 47147, 47843, 48531, 49209, 49877,
    50535, 51182, 51819, 52443, 53056, 53657, 54245, 54820,
    55381, 55930, 56464, 56984, 57489, 57980, 58455, 58915,
    59359, 59787, 60199, 60594, 60972, 61334, 61678, 62005,
    62314, 62606, 62879, 63134, 63371, 63590, 63790, 63971,
    64134, 64278, 64402, 64508, 64595, 64662, 64710, 64739,
    64749, 64739, 64710, 64662, 64595, 64508, 64402, 64278,
    64134, 63971, 63790, 63590, 63371, 63134, 62879, 62606,
    62314, 62005, 61678, 61334, 60972, 60594, 60199, 59787,
    59359, 58915, 58455, 57980, 57489, 56984, 56464, 55930,
    55381, 54820, 54245, 53657, 53056, 52443, 51819, 51182,
    50535, 49877, 49209, 48531, 47843, 47147, 46441, 45728,
    45006, 44277, 43542, 42799, 42051, 41297, 40538, 39775,
    39007, 38235, 37460, 36682, 35902, 35120, 34337, 33552,
    32768, 31983, 31198, 30415, 29633, 28853, 28075, 27300,
    26528, 25760, 24997, 24238, 23484, 22736, 21993, 21258,
    20529, 19807, 19094, 18388, 17692, 17004, 16326, 15658,
    15000, 14353, 13716, 13092, 12479, 11878, 11290, 10715,
    10154,  9605,  9071,  8551,  8046,  7555,  7080,  6620,
    6176,  5748,  5336,  4941,  4563,  4201,  3857,  3530,
    3221,  2929,  2656,  2401,  2164,  1945,  1745,  1564,
    1401,  1257,  1133,  1027,   940,   873,   825,   796,
    787,   796,   825,   873,   940,  1027,  1133,  1257,
    1401,  1564,  1745,  1945,  2164,  2401,  2656,  2929,
    3221,  3530,  3857,  4201,  4563,  4941,  5336,  5748,
    6176,  6620,  7080,  7555,  8046,  8551,  9071,  9605,
    10154, 10715, 11290, 11878, 12479, 13092, 13716, 14353,
    15000, 15658, 16326, 17004, 17692, 18388, 19094, 19807,
    20529, 21258, 21993, 22736, 23484, 24238, 24997, 25760,
    26528, 27300, 28075, 28853, 29633, 30415, 31198, 31983 };

#else

static mdc_sample_t sintable[] = {
    32768, 33314, 33861, 34407, 34952, 35495, 36037, 36577, 37115, 37650, 38182, 38710, 39236, 39757, 40274, 40787, 
    41295, 41797, 42294, 42786, 43271, 43750, 44223, 44688, 45147, 45598, 46041, 46476, 46903, 47322, 47731, 48132, 
    48523, 48905, 49278, 49640, 49992, 50334, 50665, 50985, 51295, 51593, 51880, 52155, 52419, 52671, 52910, 53138, 
    53354, 53557, 53747, 53925, 54090, 54243, 54382, 54508, 54622, 54722, 54809, 54882, 54942, 54989, 55023, 55043, 
    55050, 55043, 55023, 54989, 54942, 54882, 54809, 54722, 54622, 54508, 54382, 54243, 54090, 53925, 53747, 53557, 
    53354, 53138, 52910, 52671, 52419, 52155, 51880, 51593, 51295, 50985, 50665, 50334, 49992, 49640, 49278, 48905, 
    48523, 48132, 47731, 47322, 46903, 46476, 46041, 45598, 45147, 44688, 44223, 43750, 43271, 42786, 42294, 41797, 
    41295, 40787, 40274, 39757, 39236, 38710, 38182, 37650, 37115, 36577, 36037, 35495, 34952, 34407, 33861, 33314, 
    32768, 32222, 31675, 31129, 30584, 30041, 29499, 28959, 28421, 27886, 27354, 26826, 26300, 25779, 25262, 24749, 
    24241, 23739, 23242, 22750, 22265, 21786, 21313, 20848, 20389, 19938, 19495, 19060, 18633, 18214, 17805, 17404, 
    17013, 16631, 16258, 15896, 15544, 15202, 14871, 14551, 14241, 13943, 13656, 13381, 13117, 12865, 12626, 12398, 
    12182, 11979, 11789, 11611, 11446, 11293, 11154, 11028, 10914, 10814, 10727, 10654, 10594, 10547, 10513, 10493, 
    10486, 10493, 10513, 10547, 10594, 10654, 10727, 10814, 10914, 11028, 11154, 11293, 11446, 11611, 11789, 11979, 
    12182, 12398, 12626, 12865, 13117, 13381, 13656, 13943, 14241, 14551, 14871, 15202, 15544, 15896, 16258, 16631, 
    17013, 17404, 17805, 18214, 18633, 19060, 19495, 19938, 20389, 20848, 21313, 21786, 22265, 22750, 23242, 23739, 
    24241, 24749, 25262, 25779, 26300, 26826, 27354, 27886, 28421, 28959, 29499, 30041, 30584, 31129, 31675, 32222 };

#endif

#elif defined(MDC_SAMPLE_FORMAT_S16)
#if defined(MDC_ENCODE_FULL_AMPLITUDE)

static mdc_sample_t sintable[] = {
         0,    784,   1569,   2352,   3134,   3914,   4692,   5467, 
      6239,   7007,   7770,   8529,   9283,  10031,  10774,  11509, 
     12238,  12960,  13673,  14379,  15075,  15763,  16441,  17109, 
     17767,  18414,  19051,  19675,  20288,  20889,  21477,  22052, 
     22613,  23162,  23696,  24216,  24721,  25212,  25687,  26147, 
     26591,  27019,  27431,  27826,  28204,  28566,  28910,  29237, 
     29546,  29838,  30111,  30366,  30603,  30822,  31022,  31203, 
     31366,  31510,  31634,  31740,  31827,  31894,  31942,  31971, 
     31981,  31971,  31942,  31894,  31827,  31740,  31634,  31510, 
     31366,  31203,  31022,  30822,  30603,  30366,  30111,  29838, 
     29546,  29237,  28910,  28566,  28204,  27826,  27431,  27019, 
     26591,  26147,  25687,  25212,  24721,  24216,  23696,  23162, 
     22613,  22052,  21477,  20889,  20288,  19675,  19051,  18414, 
     17767,  17109,  16441,  15763,  15075,  14379,  13673,  12960, 
     12238,  11509,  10774,  10031,   9283,   8529,   7770,   7007,
      6239,   5467,   4692,   3914,   3134,   2352,   1569,    784,
         0,   -784,  -1569,  -2352,  -3134,  -3914,  -4692,  -5467,
     -6239,  -7007,  -7770,  -8529,  -9283, -10031, -10774, -11509,
    -12238, -12960, -13673, -14379, -15075, -15763, -16441, -17109,
    -17767, -18414, -19051, -19675, -20288, -20889, -21477, -22052,
    -22613, -23162, -23696, -24216, -24721, -25212, -25687, -26147,
    -26591, -27019, -27431, -27826, -28204, -28566, -28910, -29237,
    -29546, -29838, -30111, -30366, -30603, -30822, -31022, -31203,
    -31366, -31510, -31634, -31740, -31827, -31894, -31942, -31971,
    -31981, -31971, -31942, -31894, -31827, -31740, -31634, -31510,
    -31366, -31203, -31022, -30822, -30603, -30366, -30111, -29838,
    -29546, -29237, -28910, -28566, -28204, -27826, -27431, -27019,
    -26591, -26147, -25687, -25212, -24721, -24216, -23696, -23162,
    -22613, -22052, -21477, -20889, -20288, -19675, -19051, -18414,
    -17767, -17109, -16441, -15763, -15075, -14379, -13673, -12960,
    -12238, -11509, -10774, -10031,  -9283,  -8529,  -7770,  -7007,
     -6239,  -5467,  -4692,  -3914,  -3134,  -2352,  -1569,   -784 };

#else

static mdc_sample_t sintable[] = {

    0, 546, 1093, 1639, 2184, 2727, 3269, 3809, 4347, 4882, 5414, 5942, 6468, 6989, 7506, 8019, 
    8527, 9029, 9526, 10018, 10503, 10982, 11455, 11920, 12379, 12830, 13273, 13708, 14135, 14554, 14963, 15364, 
    15755, 16137, 16510, 16872, 17224, 17566, 17897, 18217, 18527, 18825, 19112, 19387, 19651, 19903, 20142, 20370, 
    20586, 20789, 20979, 21157, 21322, 21475, 21614, 21740, 21854, 21954, 22041, 22114, 22174, 22221, 22255, 22275, 
    22282, 22275, 22255, 22221, 22174, 22114, 22041, 21954, 21854, 21740, 21614, 21475, 21322, 21157, 20979, 20789, 
    20586, 20370, 20142, 19903, 19651, 19387, 19112, 18825, 18527, 18217, 17897, 17566, 17224, 16872, 16510, 16137, 
    15755, 15364, 14963, 14554, 14135, 13708, 13273, 12830, 12379, 11920, 11455, 10982, 10503, 10018, 9526, 9029, 
    8527, 8019, 7506, 6989, 6468, 5942, 5414, 4882, 4347, 3809, 3269, 2727, 2184, 1639, 1093, 546, 
    0, -546, -1093, -1639, -2184, -2727, -3269, -3809, -4347, -4882, -5414, -5942, -6468, -6989, -7506, -8019, 
    -8527, -9029, -9526, -10018, -10503, -10982, -11455, -11920, -12379, -12830, -13273, -13708, -14135, -14554, -14963, -15364, 
    -15755, -16137, -16510, -16872, -17224, -17566, -17897, -18217, -18527, -18825, -19112, -19387, -19651, -19903, -20142, -20370, 
    -20586, -20789, -20979, -21157, -21322, -21475, -21614, -21740, -21854, -21954, -22041, -22114, -22174, -22221, -22255, -22275, 
    -22282, -22275, -22255, -22221, -22174, -22114, -22041, -21954, -21854, -21740, -21614, -21475, -21322, -21157, -20979, -20789, 
    -20586, -20370, -20142, -19903, -19651, -19387, -19112, -18825, -18527, -18217, -17897, -17566, -17224, -16872, -16510, -16137, 
    -15755, -15364, -14963, -14554, -14135, -13708, -13273, -12830, -12379, -11920, -11455, -10982, -10503, -10018, -9526, -9029, 
    -8527, -8019, -7506, -6989, -6468, -5942, -5414, -4882, -4347, -3809, -3269, -2727, -2184, -1639, -1093, -546 };

#endif
#elif defined(MDC_SAMPLE_FORMAT_FLOAT)
#if defined(MDC_ENCODE_FULL_AMPLITUDE)

static mdc_sample_t sintable[] = {
     0.000000,  0.024541,  0.049068,  0.073565,  0.098017,  0.122411,  0.146730,  0.170962,
     0.195090,  0.219101,  0.242980,  0.266713,  0.290285,  0.313682,  0.336890,  0.359895,
     0.382683,  0.405241,  0.427555,  0.449611,  0.471397,  0.492898,  0.514103,  0.534998,
     0.555570,  0.575808,  0.595699,  0.615232,  0.634393,  0.653173,  0.671559,  0.689541,
     0.707107,  0.724247,  0.740951,  0.757209,  0.773010,  0.788346,  0.803208,  0.817585,
     0.831470,  0.844854,  0.857729,  0.870087,  0.881921,  0.893224,  0.903989,  0.914210,
     0.923880,  0.932993,  0.941544,  0.949528,  0.956940,  0.963776,  0.970031,  0.975702,
     0.980785,  0.985278,  0.989177,  0.992480,  0.995185,  0.997290,  0.998795,  0.999699,
     1.000000,  0.999699,  0.998795,  0.997290,  0.995185,  0.992480,  0.989177,  0.985278,
     0.980785,  0.975702,  0.970031,  0.963776,  0.956940,  0.949528,  0.941544,  0.932993,
     0.923880,  0.914210,  0.903989,  0.893224,  0.881921,  0.870087,  0.857729,  0.844854,
     0.831470,  0.817585,  0.803208,  0.788346,  0.773010,  0.757209,  0.740951,  0.724247,
     0.707107,  0.689541,  0.671559,  0.653173,  0.634393,  0.615232,  0.595699,  0.575808,
     0.555570,  0.534998,  0.514103,  0.492898,  0.471397,  0.449611,  0.427555,  0.405241,
     0.382683,  0.359895,  0.336890,  0.313682,  0.290285,  0.266713,  0.242980,  0.219101,
     0.195090,  0.170962,  0.146730,  0.122411,  0.098017,  0.073565,  0.049068,  0.024541,
     0.000000, -0.024541, -0.049068, -0.073565, -0.098017, -0.122411, -0.146730, -0.170962,
    -0.195090, -0.219101, -0.242980, -0.266713, -0.290285, -0.313682, -0.336890, -0.359895,
    -0.382683, -0.405241, -0.427555, -0.449611, -0.471397, -0.492898, -0.514103, -0.534998,
    -0.555570, -0.575808, -0.595699, -0.615232, -0.634393, -0.653173, -0.671559, -0.689541,
    -0.707107, -0.724247, -0.740951, -0.757209, -0.773010, -0.788346, -0.803208, -0.817585,
    -0.831470, -0.844854, -0.857729, -0.870087, -0.881921, -0.893224, -0.903989, -0.914210,
    -0.923880, -0.932993, -0.941544, -0.949528, -0.956940, -0.963776, -0.970031, -0.975702,
    -0.980785, -0.985278, -0.989177, -0.992480, -0.995185, -0.997290, -0.998795, -0.999699,
    -1.000000, -0.999699, -0.998795, -0.997290, -0.995185, -0.992480, -0.989177, -0.985278,
    -0.980785, -0.975702, -0.970031, -0.963776, -0.956940, -0.949528, -0.941544, -0.932993,
    -0.923880, -0.914210, -0.903989, -0.893224, -0.881921, -0.870087, -0.857729, -0.844854,
    -0.831470, -0.817585, -0.803208, -0.788346, -0.773010, -0.757209, -0.740951, -0.724247,
    -0.707107, -0.689541, -0.671559, -0.653173, -0.634393, -0.615232, -0.595699, -0.575808,
    -0.555570, -0.534998, -0.514103, -0.492898, -0.471397, -0.449611, -0.427555, -0.405241,
    -0.382683, -0.359895, -0.336890, -0.313682, -0.290285, -0.266713, -0.242980, -0.219101,
    -0.195090, -0.170962, -0.146730, -0.122411, -0.098017, -0.073565, -0.049068, -0.024541 };

#else

static mdc_sample_t sintable[] = {
    0.000000, 0.016688, 0.033366, 0.050024, 0.066652, 0.083239, 0.099777, 0.116254, 
    0.132661, 0.148989, 0.165227, 0.181365, 0.197394, 0.213304, 0.229085, 0.244729, 
    0.260225, 0.275564, 0.290737, 0.305736, 0.320550, 0.335171, 0.349590, 0.363798, 
    0.377788, 0.391550, 0.405076, 0.418357, 0.431387, 0.444158, 0.456660, 0.468888, 
    0.480833, 0.492488, 0.503847, 0.514902, 0.525647, 0.536076, 0.546181, 0.555958, 
    0.565399, 0.574500, 0.583255, 0.591659, 0.599706, 0.607393, 0.614713, 0.621663, 
    0.628238, 0.634435, 0.640250, 0.645679, 0.650719, 0.655368, 0.659621, 0.663477, 
    0.666934, 0.669989, 0.672640, 0.674886, 0.676726, 0.678158, 0.679181, 0.679795, 
    0.680000, 0.679795, 0.679181, 0.678158, 0.676726, 0.674886, 0.672640, 0.669989, 
    0.666934, 0.663477, 0.659621, 0.655368, 0.650719, 0.645679, 0.640250, 0.634435, 
    0.628238, 0.621663, 0.614713, 0.607393, 0.599706, 0.591659, 0.583255, 0.574500, 
    0.565399, 0.555958, 0.546181, 0.536076, 0.525647, 0.514902, 0.503847, 0.492488, 
    0.480833, 0.468888, 0.456660, 0.444158, 0.431387, 0.418357, 0.405076, 0.391550, 
    0.377788, 0.363798, 0.349590, 0.335171, 0.320550, 0.305736, 0.290737, 0.275564, 
    0.260225, 0.244729, 0.229085, 0.213304, 0.197394, 0.181365, 0.165227, 0.148989, 
    0.132661, 0.116254, 0.099777, 0.083239, 0.066652, 0.050024, 0.033366, 0.016688, 
    0.000000, -0.016688, -0.033366, -0.050024, -0.066652, -0.083239, -0.099777, -0.116254, 
    -0.132661, -0.148989, -0.165227, -0.181365, -0.197394, -0.213304, -0.229085, -0.244729, 
    -0.260225, -0.275564, -0.290737, -0.305736, -0.320550, -0.335171, -0.349590, -0.363798, 
    -0.377788, -0.391550, -0.405076, -0.418357, -0.431387, -0.444158, -0.456660, -0.468888, 
    -0.480833, -0.492488, -0.503847, -0.514902, -0.525647, -0.536076, -0.546181, -0.555958, 
    -0.565399, -0.574500, -0.583255, -0.591659, -0.599706, -0.607393, -0.614713, -0.621663, 
    -0.628238, -0.634435, -0.640250, -0.645679, -0.650719, -0.655368, -0.659621, -0.663477, 
    -0.666934, -0.669989, -0.672640, -0.674886, -0.676726, -0.678158, -0.679181, -0.679795, 
    -0.680000, -0.679795, -0.679181, -0.678158, -0.676726, -0.674886, -0.672640, -0.669989, 
    -0.666934, -0.663477, -0.659621, -0.655368, -0.650719, -0.645679, -0.640250, -0.634435, 
    -0.628238, -0.621663, -0.614713, -0.607393, -0.599706, -0.591659, -0.583255, -0.574500, 
    -0.565399, -0.555958, -0.546181, -0.536076, -0.525647, -0.514902, -0.503847, -0.492488, 
    -0.480833, -0.468888, -0.456660, -0.444158, -0.431387, -0.418357, -0.405076, -0.391550, 
    -0.377788, -0.363798, -0.349590, -0.335171, -0.320550, -0.305736, -0.290737, -0.275564, 
    -0.260225, -0.244729, -0.229085, -0.213304, -0.197394, -0.181365, -0.165227, -0.148989, 
    -0.132661, -0.116254, -0.099777, -0.083239, -0.066652, -0.050024, -0.033366, -0.016688 };

#endif
#else
#error "no known sample format defined"
#endif

// ---------------------------------------------------------------------------
//  Global Functions
// ---------------------------------------------------------------------------

/* Create a new mdc_encoder object. */

mdc_encoder_t* mdc_encoder_new(int sampleRate)
{
    mdc_encoder_t* encoder;

    encoder = (mdc_encoder_t*)malloc(sizeof(mdc_encoder_t));
    if (!encoder)
        return (mdc_encoder_t*)0L;

    encoder->loaded = 0;
    encoder->preamble_set = 0;

    if (sampleRate == 8000) {
        encoder->incru = 644245094;
        encoder->incru18 = 966367642;
    } 
    else if (sampleRate == 16000) {
        encoder->incru = 322122547;
        encoder->incru18 = 483183820;
    }
    else if (sampleRate == 22050) {
        encoder->incru = 233739716;
        encoder->incru18 = 350609575;
    }
    else if (sampleRate == 32000) {
        encoder->incru = 161061274;
        encoder->incru18 = 241591910;
    }
    else if (sampleRate == 44100) {
        encoder->incru = 116869858;
        encoder->incru18 = 175304788;
    }
    else if (sampleRate == 48000) {
        encoder->incru = 107374182;
        encoder->incru18 = 161061274;
    }
    else {
        // WARNING: lower precision than above
        encoder->incru = 1200 * 2 * (0x80000000 / sampleRate);
        encoder->incru18 = 1800 * 2 * (0x80000000 / sampleRate);
    }

    return encoder;
}

/* */

int mdc_encoder_set_preamble(mdc_encoder_t* encoder, int preambleLength)
{
    if (!encoder)
        return -1;

    if (preambleLength < 0)
        return -1;

    encoder->preamble_set = preambleLength;

    return 0;
}

/* */

static mdc_u8_t* _enc_leader(mdc_u8_t* data)
{
    data[0] = 0x55;
    data[1] = 0x55;
    data[2] = 0x55;
    data[3] = 0x55;
    data[4] = 0x55;
    data[5] = 0x55;
    data[6] = 0x55;

    data[7] = 0x07;
    data[8] = 0x09;
    data[9] = 0x2a;
    data[10] = 0x44;
    data[11] = 0x6f;

    return &(data[12]);
}

/* */

static mdc_u8_t* _enc_str(mdc_u8_t* data)
{
    mdc_u16_t ccrc;
    mdc_int_t k, m;
    mdc_int_t csr[7];
    mdc_int_t b;
    mdc_int_t lbits[112];

    ccrc = _docrc(data, 4);

    data[4] = ccrc & 0x00ff;
    data[5] = (ccrc >> 8) & 0x00ff;

    data[6] = 0; 

    for (mdc_int_t i = 0; i < 7; i++)
        csr[i] = 0;

    for (mdc_int_t i = 0; i < 7; i++) {
        data[i + 7] = 0;
        for (mdc_int_t j = 0; j <= 7; j++) {
            for (k = 6; k > 0; k--)
                csr[k] = csr[k - 1];
            csr[0] = (data[i] >> j) & 0x01;
            b = csr[0] + csr[2] + csr[5] + csr[6];
            data[i + 7] |= (b & 0x01) << j;
        }
    }

    k = 0;
    m = 0;
    for(mdc_int_t i = 0; i < 14; i++) {
        for(mdc_int_t j = 0; j <= 7; j++) {
            b = 0x01 & (data[i] >> j);
            lbits[k] = b;
            k += 16; 
            if (k > 111)
                k = ++m;
        }
    }

    k = 0;
    for (mdc_int_t i = 0; i < 14; i++) {
        data[i] = 0;
        for(mdc_int_t j = 7; j >= 0; j--) {
            if (lbits[k])
                data[i] |= 1<<j;
            ++k;
        }
    }

    return &(data[14]);
}

/* Set up a normal-length MDC packet for transmission. */

int mdc_encoder_set_packet(mdc_encoder_t* encoder, mdc_u8_t op, mdc_u8_t arg, mdc_u16_t unitID)
{
    mdc_u8_t* dp;

    if (!encoder)
        return -1;

    if (encoder->loaded)
        return -1;

    encoder->state = 0;

    dp = _enc_leader(encoder->data);

    dp[0] = op;
    dp[1] = arg;
    dp[2] = (unitID >> 8) & 0x00ff;
    dp[3] = unitID & 0x00ff;

    _enc_str(dp);

    encoder->loaded = 26;

    return 0;
}

/* Set up a double-length MDC packet for transmission. */

int mdc_encoder_set_double_packet(mdc_encoder_t* encoder, mdc_u8_t op, mdc_u8_t arg, mdc_u16_t unitID,
    mdc_u8_t extra0, mdc_u8_t extra1, mdc_u8_t extra2, mdc_u8_t extra3)
{
    mdc_u8_t* dp;

    if (!encoder)
        return -1;

    if (encoder->loaded)
        return -1;

    encoder->state = 0;

    dp = _enc_leader(encoder->data);

    dp[0] = op;
    dp[1] = arg;
    dp[2] = (unitID >> 8) & 0x00ff;
    dp[3] = unitID & 0x00ff;

    dp = _enc_str(dp);

    dp[0] = extra0;
    dp[1] = extra1;
    dp[2] = extra2;
    dp[3] = extra3;

    _enc_str(dp);

    encoder->loaded = 40;

    return 0;
}

/* */

static mdc_sample_t _enc_get_samp(mdc_encoder_t* encoder)
{
    mdc_int_t b;
    mdc_int_t ofs;

    mdc_u32_t lthu = encoder->thu;
    encoder->thu += encoder->incru;

    // wrap
    if (encoder->thu  < lthu) {
        encoder->ipos++;
        if (encoder->ipos > 7) {
            encoder->ipos = 0;
            if (encoder->preamble_count == 0)
                encoder->bpos++;
            else
                encoder->preamble_count--;

            if (encoder->bpos >= encoder->loaded) {
                encoder->state = 0;
                return sintable[0];
            }
        }

        b = 0x01 & (encoder->data[encoder->bpos] >> (7-(encoder->ipos)));

        if (b != encoder->lb) {
            encoder->xorb = 1;
            encoder->lb = b;
        }
        else
            encoder->xorb = 0;
    }

    if (encoder->xorb)
        encoder->tthu += encoder->incru18;
    else
        encoder->tthu += encoder->incru;

    ofs = (int)(encoder->tthu >> 24);

    return sintable[ofs];
}

/* Get generated output audio samples from encoder. */

int mdc_encoder_get_samples(mdc_encoder_t* encoder, mdc_sample_t* buffer, int bufferSize)
{
    if (!encoder)
        return -1;

    if (!(encoder->loaded))
        return 0;

    if (encoder->state == 0) {
        encoder->tthu = 0;
        encoder->thu = 0;
        encoder->bpos = 0;
        encoder->ipos = 0;
        encoder->state = 1;
        encoder->xorb = 1;
        encoder->lb = 0;
        encoder->preamble_count = encoder->preamble_set;
    }

    mdc_int_t i = 0;
    while ((i < bufferSize) && encoder->state) {
        buffer[i++] = _enc_get_samp(encoder);
    }

#ifdef FILL_FINAL
    while (i < bufferSize) {
        buffer[i++] = sintable[0];
    }
#endif

    if (encoder->state == 0)
        encoder->loaded = 0;
    return i;
}
